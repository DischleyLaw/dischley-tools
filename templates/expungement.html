{% extends "base.html" %}
{% block title %}Expungement Generator{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow p-4">
  <h2 class="mb-4">Expungement Petition Form</h2>
  <div class="mb-3">
    <form action="/expungement/upload" method="POST" enctype="multipart/form-data" style="margin-bottom: 2rem;">
      <label for="file"><strong>Upload Court Document (PDF):</strong></label>
      <input type="file" name="file" id="file" accept=".pdf" required>
      <button type="submit" class="btn btn-secondary">Upload & Autofill</button>
    </form>
  </div>
  <form method="POST" action="{{ url_for('expungement_form') }}?downloaded=true">
    <div class="mb-3">
      <label for="county" class="form-label">County</label>
      <select class="form-select" id="county" name="county" required onchange="fillProsecutor()">
        <option value="" {% if county == "" %}selected{% endif %}>Select County</option>
        <option value="Fairfax County" {% if county == "Fairfax County" %}selected{% endif %}>Fairfax County</option>
        <option value="Arlington County" {% if county == "Arlington County" %}selected{% endif %}>Arlington County</option>
        <option value="Prince William County" {% if county == "Prince William County" %}selected{% endif %}>Prince William County</option>
        <option value="Loudoun County" {% if county == "Loudoun County" %}selected{% endif %}>Loudoun County</option>
        <option value="City of Alexandria" {% if county == "City of Alexandria" %}selected{% endif %}>City of Alexandria</option>
        <option value="Stafford County" {% if county == "Stafford County" %}selected{% endif %}>Stafford County</option>
        <option value="Fauquier County" {% if county == "Fauquier County" %}selected{% endif %}>Fauquier County</option>
      </select>
    </div>
    <div class="mb-3">
      <label for="name" class="form-label">Full Legal Name</label>
      <input type="text" class="form-control" id="name" name="name" required value="{{ name|default('') }}">
    </div>
    <div class="mb-3">
      <label for="dob" class="form-label">Date of Birth</label>
      <input type="text" class="form-control" id="dob" name="dob" required value="{{ dob|default('') }}">
    </div>
    <div class="mb-3">
      <label for="name_arrest" class="form-label">Name at Time of Arrest</label>
      <input type="text" class="form-control" id="name_arrest" name="name_arrest" value="{{ name_arrest|default('') }}">
    </div>
    <div class="mb-3">
      <label for="expungement_type" class="form-label">Type of Expungement</label>
      <select class="form-select" id="expungement_type" name="expungement_type" onchange="toggleManifestInjustice()">
        <option value="" {% if expungement_type == "" %}selected{% endif %}>Select Type</option>
        <option value="Expungement of Right" {% if expungement_type == "Expungement of Right" %}selected{% endif %}>Expungement of Right</option>
        <option value="Manifest Injustice" {% if expungement_type == "Manifest Injustice" %}selected{% endif %}>Manifest Injustice</option>
      </select>
    </div>
    <div class="mb-3" id="manifest_injustice_details_container" style="display: none;">
      <label for="manifest_injustice_details" class="form-label">Manifest Injustice Details</label>
      <textarea class="form-control" id="manifest_injustice_details" name="manifest_injustice_details" rows="4">{{ manifest_injustice_details|default('') }}</textarea>
    </div>
    <hr />
    <h4>Charge Details #1</h4>
    <div class="mb-3">
      <label for="arrest_date" class="form-label">Date of Arrest</label>
      <input type="text" class="form-control" id="arrest_date" name="arrest_date" value="{{ arrest_date|default('') }}">
    </div>
    <div class="mb-3">
      <label for="officer_name" class="form-label">Arresting Officer</label>
      <input type="text" class="form-control" id="officer_name" name="officer_name" value="{{ officer_name|default('') }}">
    </div>
    <div class="mb-3">
      <label for="police_department" class="form-label">Law Enforcement Agency</label>
      <select class="form-select" id="police_department" name="police_department" required>
        <option value="">Select Agency</option>
        <option value="Fairfax County Police Department">Fairfax County Police Department</option>
        <option value="Arlington County Police Department">Arlington County Police Department</option>
        <option value="Prince William County Police Department">Prince William County Police Department</option>
        <option value="Loudoun County Sheriff's Office">Loudoun County Sheriff's Office</option>
        <option value="Alexandria Police Department">Alexandria Police Department</option>
        <option value="Stafford County Sheriff's Office">Stafford County Sheriff's Office</option>
        <option value="Fauquier County Sheriff's Office">Fauquier County Sheriff's Office</option>
        <option value="Virginia State Police">Virginia State Police</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="mb-3" id="other_police_department_container" style="display: none;">
      <label for="other_police_department" class="form-label">Specify Other Law Enforcement Agency</label>
      <input type="text" class="form-control" id="other_police_department" name="other_police_department" value="{{ other_police_department|default('') }}">
    </div>
    <div class="mb-3">
      <label for="charge_name" class="form-label">Charge Description</label>
      <input type="text" class="form-control" id="charge_name" name="charge_name" value="{{ charge_name|default('') }}">
    </div>
    <div class="mb-3">
      <label for="code_section" class="form-label">Code Section</label>
      <input type="text" class="form-control" id="code_section" name="code_section" value="{{ code_section|default('') }}">
    </div>
    <div class="mb-3">
      <label for="vcc_code" class="form-label">VCC Code</label>
      <input type="text" class="form-control" id="vcc_code" name="vcc_code" value="{{ vcc_code|default('') }}">
    </div>
    <div class="mb-3">
      <label for="otn" class="form-label">OTN</label>
      <input type="text" class="form-control" id="otn" name="otn" value="{{ otn|default('') }}">
    </div>
    <div class="mb-3">
      <label for="court_dispo" class="form-label">Court of Final Disposition</label>
      <input type="text" class="form-control" id="court_dispo" name="court_dispo" value="{{ court_dispo|default('') }}">
    </div>
    <div class="mb-3">
      <label for="case_no" class="form-label">Case Number</label>
      <input type="text" class="form-control" id="case_no" name="case_no" value="{{ case_no|default('') }}">
    </div>
    <div class="mb-3">
      <label for="final_dispo" class="form-label">Final Disposition</label>
      <input type="text" class="form-control" id="final_dispo" name="final_dispo" value="{{ final_dispo|default('') }}">
    </div>
    <div class="mb-3">
      <label for="dispo_date" class="form-label">Disposition Date</label>
      <input type="text" class="form-control" id="dispo_date" name="dispo_date" value="{{ dispo_date|default('') }}">
    </div>
    <button type="button" class="btn btn-outline-primary mt-3" onclick="addAdditionalCaseSection()">Add Additional Case</button>
    <div id="additionalCasesContainer" class="mt-4"></div>
    <template id="additional-case-template">
      <div class="border p-3 mt-3">
        <h4 class="mt-4">Charge Details #<span class="case-index">2</span></h4>
        <div class="mb-3"><label>Arrest Date</label><input type="text" name="case_2_arrest_date" class="form-control"></div>
        <div class="mb-3"><label>Officer Name</label><input type="text" name="case_2_officer_name" class="form-control"></div>
        <div class="mb-3"><label>Police Department</label><input type="text" name="case_2_police_department" class="form-control"></div>
        <div class="mb-3"><label>Charge Name</label><input type="text" name="case_2_charge_name" class="form-control"></div>
        <div class="mb-3"><label>Code Section</label><input type="text" name="case_2_code_section" class="form-control"></div>
        <div class="mb-3"><label>VCC Code</label><input type="text" name="case_2_vcc_code" class="form-control"></div>
        <div class="mb-3"><label>OTN</label><input type="text" name="case_2_otn" class="form-control"></div>
        <div class="mb-3"><label>Court of Final Dispo</label><input type="text" name="case_2_court_dispo" class="form-control"></div>
        <div class="mb-3"><label>Case No</label><input type="text" name="case_2_case_no" class="form-control"></div>
        <div class="mb-3"><label>Dispo Date</label><input type="text" name="case_2_dispo_date" class="form-control"></div>
      </div>
    </template>
    <hr />
    <h4>Prosecutor Info</h4>
    <div class="mb-3">
      <label for="prosecutor" class="form-label">Prosecutor Name</label>
      <input type="text" class="form-control" id="prosecutor" name="prosecutor" value="{{ prosecutor|default('') }}">
    </div>
    <div class="mb-3">
      <label for="prosecutor_title" class="form-label">Prosecutor Title</label>
      <input type="text" class="form-control" id="prosecutor_title" name="prosecutor_title" value="{{ prosecutor_title|default('') }}">
    </div>
    <div class="mb-3">
      <label for="prosecutor_address1" class="form-label">Address Line 1</label>
      <input type="text" class="form-control" id="prosecutor_address1" name="prosecutor_address1" value="{{ prosecutor_address1|default('') }}">
    </div>
    <div class="mb-3">
      <label for="prosecutor_address2" class="form-label">Address Line 2</label>
      <input type="text" class="form-control" id="prosecutor_address2" name="prosecutor_address2" value="{{ prosecutor_address2|default('') }}">
    </div>
    <hr />
    <h4>Filing Information</h4>
    <div class="mb-3">
      <label for="month" class="form-label">Month of Petition</label>
      <input type="text" class="form-control" id="month" name="month" value="{{ current_month }}">
    </div>
    <div class="mb-3">
      <label for="year" class="form-label">Year of Petition</label>
      <input type="text" class="form-control" id="year" name="year" value="{{ current_year }}">
    </div>
    <div class="mb-3">
      <label for="attorney" class="form-label">Attorney Name</label>
      <select class="form-select" id="attorney" name="attorney" required>
        <option value="David J. Dischley (VSB No. 73703)" {% if attorney == "David J. Dischley (VSB No. 73703)" %}selected{% endif %}>David J. Dischley (VSB No. 73703)</option>
        <option value="Patrick T. O'Brien (VSB No. 81211)" {% if attorney == "Patrick T. O'Brien (VSB No. 81211)" %}selected{% endif %}>Patrick T. O'Brien (VSB No. 81211)</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Generate Petition</button>
    <button type="reset" class="btn btn-danger ms-2">Clear Form</button>
  </form>
      </div>
    </div>
  </div>
</div>
<script>
  const prosecutorData = {
    "Fairfax County": {
      name: "Steve Descano, Esq.",
      title: "Fairfax County Commonwealth's Attorney",
      address1: "4110 Chain Bridge Road",
      address2: "Fairfax, VA 22030"
    },
    "Arlington County": {
      name: "Parisa Tafti, Esq.",
      title: "Arlington County Commonwealth's Attorney",
      address1: "1425 N. Courthouse Rd",
      address2: "Arlington, VA 22201"
    },
    "Prince William County": {
      name: "Amy Ashworth, Esq.",
      title: "Prince William County Commonwealth's Attorney",
      address1: "9311 Lee Ave",
      address2: "Manassas, VA 20110"
    },
    "Loudoun County": {
      name: "Robert Anderson, Esq.",
      title: "Loudoun County Commonwealth's Attorney",
      address1: "20 E Market St",
      address2: "Leesburg, VA 20176"
    },
    "City of Alexandria": {
      name: "Bryan Porter, Esq.",
      title: "Alexandria City Commonwealth's Attorney",
      address1: "520 King Street",
      address2: "Alexandria, VA 22314"
    },
    "Stafford County": {
      name: "Eric Olsen, Esq.",
      title: "Stafford County Commonwealth's Attorney",
      address1: "1245 Courthouse Road",
      address2: "Stafford, VA 22555"
    },
    "Fauquier County": {
      name: "Scott Hook, Esq.",
      title: "Fauquier County Commonwealth's Attorney",
      address1: "29 Ashby Street",
      address2: "Warrenton, VA 20186"
    }
  };

  function fillProsecutor() {
    const county = document.getElementById('county').value;
    const data = prosecutorData[county] || {};
    document.getElementById('prosecutor').value = data.name || '';
    document.getElementById('prosecutor_title').value = data.title || '';
    document.getElementById('prosecutor_address1').value = data.address1 || '';
    document.getElementById('prosecutor_address2').value = data.address2 || '';
  }
</script>
<script>
  function toggleManifestInjustice() {
    const type = document.getElementById('expungement_type').value;
    const container = document.getElementById('manifest_injustice_details_container');
    container.style.display = (type === 'Manifest Injustice') ? 'block' : 'none';
  }
</script>
<script>
  document.getElementById('police_department').addEventListener('change', function () {
    const otherContainer = document.getElementById('other_police_department_container');
    otherContainer.style.display = this.value === 'Other' ? 'block' : 'none';
  });
</script>
<script>
  if (window.location.search.includes("downloaded=true")) {
    const params = new URLSearchParams(window.location.search);
    const name = document.getElementById("name")?.value || "Client";
    window.location.href = `/expungement/success?name=${encodeURIComponent(name)}`;
  }
</script>
{% endblock %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  let additionalCaseCount = 2;

  window.addAdditionalCaseSection = function () {
    additionalCaseCount++;
    const container = document.getElementById("additionalCasesContainer");
    const template = document.getElementById("additional-case-template");
    if (!template) return;

    const clone = template.content.cloneNode(true);
    clone.querySelectorAll("input").forEach(input => {
      const name = input.getAttribute("name");
      if (name && name.startsWith("case_2_")) {
        input.setAttribute("name", name.replace(/^case_2_/, `case_${additionalCaseCount}_`));
      }
    });
    clone.querySelectorAll(".case-index").forEach(el => el.textContent = additionalCaseCount);
    container.appendChild(clone);
  };
});
</script>