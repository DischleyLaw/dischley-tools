replacements = {}

for key, value in request.form.items():
    if key.startswith("{") and key.endswith("}"):
        replacements[key] = value

# Add uppercased NAME if present
if "{NAME}" in replacements:
    replacements["{NAME}"] = replacements["{NAME}"].upper()

# Add county and prosecutor details
county = request.form.get("county", "").strip()
expungement_type = request.form.get("expungement_type", "").strip()
final_disposition = request.form.get("final_disposition", "").strip()
manifest_injustice = request.form.get("manifest_injustice", "").strip()

prosecutor = prosecutor_info.get(county, {})
replacements.update({
    "{COUNTY}": county.upper(),
    "{County2}": county.title(),
    "{Prosecutor}": prosecutor.get("name", ""),
    "{Prosecutor Title}": prosecutor.get("title", ""),
    "{Prosecutor Address 1}": prosecutor.get("address1", ""),
    "{Prosecutor Address 2}": prosecutor.get("address2", ""),
    "{Final Disposition}": final_disposition,
    "{Type of Expungement}": (
        "The Petitioner has no prior criminal record..." if expungement_type == "Expungement of Right"
        else f"The continued existence... constitutes a manifest injustice... (to wit: {manifest_injustice})."
    )
})

# Add any fallback from Clio contact if NAME is still not present
clio_contact_id = request.form.get("clio_contact_id", "").strip()
if "{NAME}" not in replacements and clio_contact_id:
    try:
        access_token = get_valid_token()
        headers = {"Authorization": f"Bearer {access_token}"}
        contact_url = f"https://app.clio.com/api/v4/contacts/{clio_contact_id}"
        response = requests.get(contact_url, headers=headers)
        if response.status_code == 200:
            contact = response.json().get("data", {})
            if contact.get("type") == "Person":
                replacements["{NAME}"] = f"{contact.get('first_name', '').strip()} {contact.get('last_name', '').strip()}"
            else:
                replacements["{NAME}"] = contact.get("name", "").strip()
    except Exception as e:
        print("Failed to fetch Clio contact:", e)